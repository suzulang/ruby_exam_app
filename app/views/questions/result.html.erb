<div class="container mt-5">
  <h1 class="mb-4">测试结果</h1>
  <p class="lead">您的得分：<%= @score %> / <%= @questions.count %></p>

  <div class="question-results mt-5">
    <% @questions.each do |question| %>
      <div class="card mb-4">
        <div class="card-body">
          <h5 class="card-title"><%= question.content %></h5>
          
          <% if question.code.present? %>
            <pre><code class="ruby"><%= question.code %></code></pre>
          <% end %>

          <p class="card-text">
            <strong>正确答案：</strong> <%= question.correct_answer %>
          </p>

          <p class="card-text">
            <strong>您的答案：</strong> 
            <% user_answer = @user_answers[question.id.to_s] %>
            <%= user_answer.is_a?(Array) ? user_answer.join(', ') : user_answer || '未作答' %>
          </p>

          <% if question.explanation.present? %>
            <p class="card-text">
              <strong>解释：</strong> <%= question.explanation %>
            </p>
          <% end %>

          <% correct_answer = question.correct_answer.split(',').sort %>
          <% user_answer = @user_answers[question.id.to_s] %>
          <% user_answer = user_answer.is_a?(Array) ? user_answer.sort : [user_answer].compact %>
          <% if user_answer == correct_answer %>
            <div class="alert alert-success mt-3">回答正确</div>
          <% else %>
            <div class="alert alert-danger mt-3">回答错误</div>
          <% end %>
        </div>
      </div>
    <% end %>
  </div>

  <%= link_to '重新开始', questions_path, class: 'btn btn-primary mt-4' %>
</div>